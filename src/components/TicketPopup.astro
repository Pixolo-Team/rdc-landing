---
// TYPES //
import type { SuccessRegistrationResponseData } from "../types/form";

// INTERFACES //
interface Props {
  registrationSuccessDetails: SuccessRegistrationResponseData;
}

const { registrationSuccessDetails } = Astro.props as Props;
---

<!-- Backdrop overlay -->
<div
  id="ticketBackdrop"
  class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm"
>
  <div
    id="ticketCard"
    class="relative w-[570px] max-w-md rounded-2xl bg-n-50 shadow-2xl py-7 lg:py-6"
  >
    <!-- Ticket Popup Header -->
    <div
      class="flex items-center justify-between gap-10 w-full px-6"
      data-sal="slide-down"
      data-sal-duration="400"
    >
      <!-- Microsoft -->
      <a href="#" class="w-2/5">
        <img src="/images/microsoft-logo.png" alt="Microsoft" class="w-full" />
      </a>

      <!-- Brand logo -->
      <a href="#" class="w-1/4">
        <img
          src="/images/reliance-digital-logo.png"
          alt="Brand"
          class="w-full"
        />
      </a>
    </div>
    <!-- Ticket image + Details -->
    <div class="py-7 lg:py-6">
      <!-- Ticket top image -->
      <div class="px-8 flex justify-center items-center relative z-[999]">
        <img src="/images/ticket-top-bg.png" alt="" class="-mb-4 lg:w-[92%]" />
      </div>
      <!-- Basic Details with background -->
      <div
        class="bg-[url('/images/form-bg.png')] bg-center text-n-50 py-12 lg:py-8 px-8 text-center flex flex-col gap-5 lg:gap-4"
      >
        <!-- Name -->
        <p class="text-3xl font-semibold">
          {registrationSuccessDetails.full_name}
        </p>
        <!-- Slot time -->
        <p class="text-xl font-medium">
          {registrationSuccessDetails.appointment_time}
        </p>
        <div>
          <!-- Venue label -->
          <p
            class="text-xl text-red-500 font-semibold uppercase tracking-widest pb-1"
          >
            Venue
          </p>
          <!-- Venue address -->
          <p class="text-xl font-medium">
            {registrationSuccessDetails.location}
          </p>
        </div>
      </div>
    </div>
    <!-- Ticket Confirmation Number -->
    <div>
      <p class="font-medium text-4xl text-center">
        {registrationSuccessDetails.confirmation_number}
      </p>
    </div>
    <!-- Download Button (hidden in export) -->
    <div class="text-center py-6">
      <button
        id="downloadTicketPng"
        class="px-6 py-2 rounded-lg bg-red-500 text-n-50 font-semibold hover:bg-red-600 transition"
      >
        Download Ticket
      </button>
    </div>
  </div>
</div>
<script is:inline>
  (function () {
    // Backrop inside TicketPopup
    const backdrop = document.getElementById("ticketBackdrop");
    // Outer wrapper you toggle elsewhere: <div id="ticketPopup" class="hidden"> <TicketPopup/> </div>
    const wrapper = document.getElementById("ticketPopup");
    if (!backdrop || !wrapper) return;

    // Close on backdrop click: toggle hidden/block
    backdrop.addEventListener("click", () => {
      wrapper.classList.add("hidden");
      wrapper.classList.remove("block");
      document.documentElement.classList.remove("overflow-y-hidden"); // optional: unlock scroll
    });
  })();
</script>

<!-- html2canvas -->
<script
  src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
></script>

<script is:inline>
  (function () {
    const downloadBtn = document.getElementById("downloadTicketPng");
    const ticketCard = document.getElementById("ticketCard");

    if (downloadBtn && ticketCard) {
      downloadBtn.addEventListener("click", async () => {
        // hide button before capture
        downloadBtn.style.display = "none";

        const canvas = await html2canvas(ticketCard, {
          useCORS: true,
          scale: 2,
        });

        // show button back
        downloadBtn.style.display = "block";

        // trigger download
        const link = document.createElement("a");
        link.download = "ticket.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }
  })();
</script>
